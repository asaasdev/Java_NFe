podTemplate(
        name: 'build-services',
        namespace: 'jenkins ',
        label: 'build-services',
        containers:
                [containerTemplate(
                        args: 'cat',
                        command: '/bin/sh -c',
                        image: 'baseerp/docker:1.4',
                        livenessProbe: containerLivenessProbe(execArgs: '',
                                failureThreshold: 0,
                                initialDelaySeconds: 0,
                                periodSeconds: 0,
                                successThreshold: 0,
                                timeoutSeconds: 0),
                        name: 'docker-container',
                        resourceLimitCpu: '',
                        resourceLimitMemory: '',
                        resourceRequestCpu: '',
                        resourceRequestMemory: '',
                        ttyEnabled: true,
                        workingDir: '/home/jenkins/agent')
                ],
        volumes: [hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock')],
        nodeSelector: 'type=jenkins-worker',
)
        {
            node('build-services') {

                echo '*********************************************************Parametros************************************************************************'
                echo '*******************************************************************************************************************************************'
                echo "Ambiente:  ${Ambiente}"
                echo "Branch:  ${Branch}"
                echo '*******************************************************************************************************************************************'
                echo '*******************************************************************************************************************************************'

                def gitRepos = ""
                def namespace = "${Ambiente}"
                def executarTestes = "${Testes}"
                def imagem_build = "baseerp/services-build"
                def versao = "1.0.${currentBuild.number}"
                def git_branch = ""
                def DskipTests = "-DskipTests"
                if (executarTestes.toLowerCase().equals("sim")) {
                    DskipTests = ""
                }

                stage('Checkout') {
                    echo '*********************************************************Checkout************************************************************************'
                    gitRepos = checkout scm
                    git_branch = gitRepos.GIT_BRANCH
                    versao = versao + '-' + namespace
                    echo 'Reposit√≥rio :' + gitRepos.toString()
                    echo 'Branch :' + git_branch.toString()
                }

                stage('Package') {
                    container('docker-container') {
                        echo '*********************************************************Package************************************************************************'
                        withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'DOCKER_HUB_PASSWORD', usernameVariable: 'DOCKER_HUB_USER')]) {
                            withCredentials([usernamePassword(credentialsId: 'nexus', passwordVariable: 'NEXUS_PASSWORD', usernameVariable: 'NEXUS_USER')]) {
                                def mavenImage = "baseerp/maven-services"
                                def mavenImageVersion = "1.3"
                                sh label: '', script: "docker login -u ${DOCKER_HUB_USER} -p ${DOCKER_HUB_PASSWORD}"
                                sh label: '', script: "docker build -f Dockerfile-build -t ${imagem_build}:${versao} . --build-arg mavenImage=${mavenImage} --build-arg mavenImageVersion=${mavenImageVersion} --build-arg nameSpace=${namespace} --build-arg DskipTests=${DskipTests} --build-arg nexusUser=${NEXUS_USER} --build-arg nexusPass=${NEXUS_PASSWORD} --network=host"
                                sh label: '', script: "docker rmi ${imagem_build}:${versao} --force"
                            }
                        }
                    }
                }

            }
        }